name: Copy and Rename Home Files

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # 也可以手动触发
  workflow_dispatch:

jobs:
  copy-home-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Find and process home files
      run: |
        # 查找所有名为 home 的文件（包括各种扩展名）
        find . -type f -name "home*" | while read filepath; do
          # 获取文件所在目录
          dirpath=$(dirname "$filepath")
          
          # 如果不在根目录（即目录路径不是 ".")
          if [ "$dirpath" != "." ]; then
            # 获取文件名和扩展名
            filename=$(basename "$filepath")
            
            # 分离文件名和扩展名
            if [[ "$filename" =~ ^home(\..+)?$ ]]; then
              if [[ "$filename" == "home" ]]; then
                # 没有扩展名的情况
                extension=""
                new_filename=$(basename "$dirpath")
              else
                # 有扩展名的情况
                extension="${filename#home}"
                new_filename="$(basename "$dirpath")$extension"
              fi
              
              # 获取父目录路径
              parent_dir=$(dirname "$dirpath")
              
              # 构建新文件路径
              new_filepath="$parent_dir/$new_filename"
              
              echo "Copying $filepath to $new_filepath"
              
              # 复制文件
              cp "$filepath" "$new_filepath"
            fi
          fi
        done
    
    - name: Check for changes
      id: check_changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Auto-copied home files to parent directory"
        git push
